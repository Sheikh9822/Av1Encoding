name: AV1 Mini Encode Test

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: "Direct video URL"
        required: true

      crf:
        description: "CRF value (31-45 recommended)"
        default: "40"

      sample_start:
        description: "Start time in seconds (0 = full video)"
        default: "0"

      sample_duration:
        description: "Duration seconds (0 = full video)"
        default: "120"

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y ffmpeg mkvtoolnix wget mediainfo xz-utils

    - name: Install Static FFmpeg (with libvmaf)
      run: |
        wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz
        tar -xf ffmpeg-release-amd64-static.tar.xz
        FFMPEG_STATIC=$(find . -name "ffmpeg" -path "*/ffmpeg-*-amd64-static/ffmpeg" | head -1)
        sudo cp "$FFMPEG_STATIC" /usr/local/bin/ffmpeg_vmaf
        ffmpeg_vmaf -version | head -1

    - name: Show System Info
      run: |
        lscpu
        free -h
        df -h

    - name: Download Source
      run: |
        echo "Downloading source..."
        wget -O input.mkv "${{ github.event.inputs.source_url }}"

    - name: Media Info
      run: mediainfo input.mkv

    - name: Encode + Extract Reference (Parallel)
      run: |
        CRF=${{ github.event.inputs.crf }}
        START=${{ github.event.inputs.sample_start }}
        DURATION=${{ github.event.inputs.sample_duration }}

        echo "CRF: $CRF"
        echo "Start: $START"
        echo "Duration: $DURATION"

        CUT=""
        if [ "$DURATION" != "0" ]; then
          CUT="-ss $START -t $DURATION"
          echo "Encoding SAMPLE CLIP"
        else
          echo "Encoding FULL VIDEO"
        fi

        # Build metadata flags as an array to safely handle spaces in titles
        METADATA_FLAGS=()
        AUDIO_IDX=0
        SUB_IDX=0
        VIDEO_DONE=0

        while IFS='|' read -r TYPE LANG TITLE; do
          case "$TYPE" in
            video)
              if [ "$VIDEO_DONE" = "0" ]; then
                SPECIFIER="v:0"
                VIDEO_DONE=1
              else
                continue
              fi
              ;;
            audio)
              SPECIFIER="a:$AUDIO_IDX"
              AUDIO_IDX=$((AUDIO_IDX + 1))
              ;;
            subtitle)
              SPECIFIER="s:$SUB_IDX"
              SUB_IDX=$((SUB_IDX + 1))
              ;;
            *) continue ;;
          esac
          [ -n "$LANG" ]  && METADATA_FLAGS+=(-metadata:s:$SPECIFIER "language=$LANG")
          [ -n "$TITLE" ] && METADATA_FLAGS+=(-metadata:s:$SPECIFIER "title=$TITLE")
        done < <(ffprobe -v quiet \
          -show_entries stream=codec_type:stream_tags=language,title \
          -of csv=p=0 input.mkv 2>/dev/null | \
          awk -F',' '{print $1"|"$2"|"$3}')

        echo "Metadata flags: ${METADATA_FLAGS[@]}"

        # Start reference extraction in background
        echo "Starting reference extraction in background..."
        ffmpeg $CUT -i input.mkv -map 0:v:0 -c:v copy reference.mkv &
        REF_PID=$!

        # Start encode in background
        echo "Starting AV1 encode in background..."
        ffmpeg $CUT -i input.mkv \
        -map 0:v:0 -map 0:a? -map 0:s? \
        -map_metadata 0 \
        -map_metadata:s -1 \
        "${METADATA_FLAGS[@]}" \
        -vf "hqdn3d=0.8:0.8:3:3,gradfun=1.2" \
        -c:v libsvtav1 \
        -pix_fmt yuv420p10le \
        -preset 6 \
        -crf $CRF \
        -svtav1-params "tune=0:aq-mode=1:enable-overlays=0:scd=0:fast-decode=1" \
        -af "aformat=channel_layouts='5.1|stereo|mono'" \
        -c:a libopus -b:a 64k \
        -c:s copy \
        output.mkv &
        ENCODE_PID=$!

        echo "Waiting for reference extraction..."
        wait $REF_PID || { echo "Reference extraction failed"; exit 1; }
        echo "Reference done."

        echo "Waiting for encode..."
        wait $ENCODE_PID || { echo "Encode failed"; exit 1; }
        echo "Encode done."

    - name: Show Output Info
      run: |
        mediainfo output.mkv
        ls -lh

    - name: VMAF Score
      run: |
        ffmpeg_vmaf -i output.mkv -i reference.mkv \
          -lavfi "[0:v][1:v]libvmaf=log_fmt=json:log_path=vmaf.json:n_threads=$(nproc)" \
          -f null -

        echo ""
        echo "============================================================"
        echo "VMAF RESULTS"
        echo "============================================================"
        python3 -c "
        import json
        with open('vmaf.json') as f:
            data = json.load(f)
        pooled = data['pooled_metrics']
        print(f\"VMAF Score  : {pooled['vmaf']['mean']:.4f}\")
        print(f\"  Min       : {pooled['vmaf']['min']:.4f}\")
        print(f\"  Max       : {pooled['vmaf']['max']:.4f}\")
        print(f\"  Harmonic  : {pooled['vmaf']['harmonic_mean']:.4f}\")
        "
        echo "============================================================"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: encoded-crf${{ github.event.inputs.crf }}-run${{ github.run_number }}
        path: |
          output.mkv
          vmaf.json