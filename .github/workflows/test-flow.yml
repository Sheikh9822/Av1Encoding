name: AV1 Ultimate (Fixed & Robust)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: "Direct video URL"
        required: true
      crf:
        description: "CRF (38-42 anime small, 33-37 quality, 28-32 archival)"
        default: "42"
      max_bitrate:
        description: "Safety Maxrate (0 = off, e.g. 800k)"
        default: "800k"
      preset:
        description: "Preset (6 = Balanced, 4 = Best Quality/Slow)"
        default: "6"
      film_grain:
        description: "Film Grain Synthesis (0-50). Use 4-8 for grainy sources."
        default: "0"
      denoise:
        description: "Enable Denoise for noisy sources (true/false)"
        default: "false"
      deband:
        description: "Enable Debanding for banded sources (true/false)"
        default: "false"
      strip_attachments:
        description: "Strip font attachments (true/false)"
        default: "true"
      sample_start:
        description: "Start Time in seconds (e.g. 120)"
        default: "0"
      sample_duration:
        description: "Duration in seconds (0 = Full encode)"
        default: "60"

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v4

    # --- 1. SMART CACHING & SETUP ---
    - name: Cache Tools
      id: cache-tools
      uses: actions/cache@v4
      with:
        path: tools
        key: ${{ runner.os }}-ffmpeg-static-v2

    - name: Download FFmpeg (Static)
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        mkdir -p tools
        wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
        tar -xf ffmpeg-master-latest-linux64-gpl.tar.xz -C tools --strip-components=1
        rm ffmpeg-master-latest-linux64-gpl.tar.xz

    - name: Install Dependencies
      run: |
        # Add custom FFmpeg to path
        echo "$(pwd)/tools/bin" >> $GITHUB_PATH
        # Install Mediainfo and ImageMagick (convert)
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends mediainfo fonts-dejavu imagemagick

    # --- 2. DOWNLOAD SOURCE ---
    - name: Download Source
      run: |
        wget --header="Referer: https://kwik.cx/" \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
             -O input.mkv "${{ github.event.inputs.source_url }}"

    # --- 3. CONFIGURE ---
    - name: Configure Environment
      id: prep
      shell: bash
      run: |
        # CUT ARGS
        START="${{ github.event.inputs.sample_start }}"
        DURATION="${{ github.event.inputs.sample_duration }}"
        CUT_ARGS=""
        if [ "$START" != "0" ]; then CUT_ARGS="-ss $START"; fi
        if [ "$DURATION" != "0" ]; then CUT_ARGS="$CUT_ARGS -t $DURATION"; fi
        echo "CUT_ARGS=$CUT_ARGS" >> $GITHUB_ENV

        # MAXRATE / BUFSIZE
        MAXRATE="${{ github.e