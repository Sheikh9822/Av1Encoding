name: AV1 Ultimate (Dynamic Naming)

on:
  workflow_dispatch:
    inputs:
      source_url:
        description: "Direct video URL"
        required: true
      crf:
        description: "CRF (38-42 anime small, 33-37 quality, 28-32 archival)"
        default: "42"
      preset:
        description: "Preset (6 = Balanced, 4 = Best Quality/Slow)"
        default: "6"
      tune:
        description: "Tune (0 = Visual Quality, 1 = PSNR)"
        default: "0"
      audio_bitrate:
        description: "Audio Bitrate (64k, 96k, 128k, 160k)"
        default: "128k"
      max_bitrate:
        description: "Safety Maxrate (0 = off, e.g. 800k)"
        default: "800k"
      film_grain:
        description: "Film Grain Synthesis (0-50)"
        default: "0"
      denoise:
        description: "Enable Denoise (true/false)"
        default: "false"
      deband:
        description: "Enable Debanding (true/false)"
        default: "false"
      strip_attachments:
        description: "Strip font attachments (true/false)"
        default: "true"
      sample_start:
        description: "Start Time in seconds"
        default: "0"
      sample_duration:
        description: "Duration (0 = Full encode)"
        default: "60"

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - uses: actions/checkout@v4

    - name: Cache Tools
      id: cache-tools
      uses: actions/cache@v4
      with:
        path: tools
        key: ${{ runner.os }}-ffmpeg-static-v1

    - name: Download FFmpeg (Static)
      if: steps.cache-tools.outputs.cache-hit != 'true'
      run: |
        mkdir -p tools
        wget -q https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
        tar -xf ffmpeg-master-latest-linux64-gpl.tar.xz -C tools --strip-components=1
        rm ffmpeg-master-latest-linux64-gpl.tar.xz

    - name: Install Dependencies
      run: |
        echo "$(pwd)/tools/bin" >> $GITHUB_PATH
        sudo apt-get update -y
        sudo apt-get install -y --no-install-recommends mediainfo imagemagick fonts-dejavu

    - name: Download Source
      run: |
        wget --header="Referer: https://kwik.cx/" \
             --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64)" \
             -O input.mkv "${{ github.event.inputs.source_url }}"

    - name: Configure Environment
      id: prep
      shell: bash
      run: |
        # 1. Determine Output Filename from Metadata or URL
        RAW_TITLE=$(ffprobe -v quiet -show_entries format_tags=title -of default=noprint_wrappers=1:nokey=1 input.mkv | head -n 1)
        
        if [ -z "$RAW_TITLE" ]; then
          # Fallback to URL filename if metadata title is empty
          RAW_TITLE=$(basename "${{ github.event.inputs.source_url }}" | cut -d? -f1 | sed 's/\.[^.]*$//')
        fi
        
        # Sanitize filename: replace spaces and special chars with underscores
        CLEAN_NAME=$(echo "$RAW_TITLE" | sed 's/[^a-zA-Z0-9._-]/_/g' | sed 's/__+/_/g')
        OUT_NAME="${CLEAN_NAME}.mkv"
        echo "OUT_NAME=$OUT_NAME" >> $GITHUB_ENV
        echo "Final Output Name: $OUT_NAME"

        # 2. Configure Trim/Cut
        START="${{ github.event.inputs.sample_start }}"
        DURATION="${{ github.event.inputs.sample_duration }}"
        CUT_ARGS=""
        if [ "$START" != "0" ]; then CUT_ARGS="-ss $START"; fi
        if [ "$DURATION" != "0" ]; then CUT_ARGS="$CUT_ARGS -t $DURATION"; fi
        echo "CUT_ARGS=$CUT_ARGS" >> $GITHUB_ENV
        
        # 3. Configure Bitrate
        MAXRATE="${{ github.event.inputs.max_bitrate }}"
        if [ "$MAXRATE" = "0" ] || [ -z "$MAXRATE" ]; then
          echo "RATE_ARGS=" >> $GITHUB_ENV
        else
          BITRATE_VAL=$(echo "$MAXRATE" | tr -dc '0-9')
          BUF_VAL=$(( BITRATE_VAL * 4 ))
          echo "RATE_ARGS=-maxrate $MAXRATE -bufsize ${BUF_VAL}k" >> $GITHUB_ENV
        fi
        
        # 4. Configure SVT-AV1 Params
        THREADS=$(nproc)
        PARAMS="aq-mode=2:enable-overlays=1:scd=1:lookahead=60:keyint=360:irefresh-type=2:lp=$THREADS:tune=${{ github.event.inputs.tune }}"
        GRAIN="${{ github.event.inputs.film_grain }}"
        if [ "$GRAIN" -gt "0" ]; then
          PARAMS="$PARAMS:film-grain=$GRAIN:film-grain-denoise=1"
        fi
        echo "SVT_PARAMS=$PARAMS" >> $GITHUB_ENV
        
        # 5. Configure Filters
        VFILTER=""
        if [ "${{ github.event.inputs.denoise }}" = "true" ]; then VFILTER="hqdn3d=1:1:3:3"; fi
        if [ "${{ github.event.inputs.deband }}" = "true" ]; then
          [ -n "$VFILTER" ] && VFILTER="$VFILTER,"
          VFILTER="${VFILTER}gradfun=1.5:16"
        fi
        [ -z "$VFILTER" ] && VFILTER="null"
        echo "VFILTER=$VFILTER" >> $GITHUB_ENV
        
        # 6. Configure Metadata & Audio (Fixing CSV logic)
        METADATA_FLAGS=()
        [ -n "$RAW_TITLE" ] && METADATA_FLAGS+=("-metadata" "title=$RAW_TITLE")
        
        AUDIO_MAP=""
        AUDIO_FILTER=""
        A_IDX=0
        S_IDX=0
        
        # Use Pipe delimiter for robustness
        ffprobe -v quiet -show_entries stream=codec_type,channels:stream_tags=language,title -of csv=p=0:s="|" input.mkv > streams.csv
        
        while IFS='|' read -r TYPE CHANNELS LANG TITLE; do
          TITLE="${TITLE%\"}"; TITLE="${TITLE#\"}"
          case "$TYPE" in
            audio)
              SPEC="a:$A_IDX"
              if [ "${CHANNELS:-0}" -gt 2 ]; then
                AUDIO_FILTER+="[0:a:$A_IDX]aformat=channel_layouts='5.1|stereo|mono',pan=stereo|FL=FC+0.30*FL+0.30*BL+0.21*LFE|FR=FC+0.30*FR+0.30*BR+0.21*LFE[a$A_IDX];"
                AUDIO_MAP+="-map [a$A_IDX] "
              else
                AUDIO_MAP+="-map 0:a:$A_IDX "
              fi
              [ -n "$LANG" ] && METADATA_FLAGS+=("-metadata:s:$SPEC" "language=$LANG")
              METADATA_FLAGS+=("-metadata:s:$SPEC" "title=${TITLE:-Audio} Stereo")
              A_IDX=$((A_IDX + 1))
              ;;
            subtitle)
              SPEC="s:$S_IDX"
              [ -n "$LANG" ] && METADATA_FLAGS+=("-metadata:s:$SPEC" "language=$LANG")
              [ -n "$TITLE" ] && METADATA_FLAGS+=("-metadata:s:$SPEC" "title=$TITLE")
              S_IDX=$((S_IDX + 1))
              ;;
          esac
        done < streams.csv
        
        [ -n "$AUDIO_FILTER" ] && AUDIO_FILTER="${AUDIO_FILTER%;}"
        echo "AUDIO_MAP=$AUDIO_MAP" >> $GITHUB_ENV
        echo "AUDIO_FILTER=$AUDIO_FILTER" >> $GITHUB_ENV
        printf "%s\0" "${METADATA_FLAGS[@]}" > metadata_flags.bin

    - name: Extract Reference
      run: |
        ffmpeg -hide_banner -y $CUT_ARGS -i input.mkv -map 0:v:0 -c:v libx264 -qp 0 -preset ultrafast reference.mkv

    - name: Run AV1 Encode
      shell: bash
      run: |
        METADATA_ARGS=()
        if [ -f metadata_flags.bin ]; then
          while IFS= read -r -d '' flag; do METADATA_ARGS+=("$flag"); done < metadata_flags.bin
        fi
        F_ARGS=()
        [ -n "$AUDIO_FILTER" ] && F_ARGS=(-filter_complex "$AUDIO_FILTER")
        
        ffmpeg -hide_banner -y \
          -probesize 50M -analyzeduration 50M \
          $CUT_ARGS -i input.mkv \
          -map 0:v:0 $AUDIO_MAP -map 0:s? \
          ${{ github.event.inputs.strip_attachments == 'true' && '-map -0:t' || '' }} \
          -map_metadata 0 -map_metadata:s -1 \
          "${METADATA_ARGS[@]}" "${F_ARGS[@]}" \
          -vf "$VFILTER" \
          -c:v libsvtav1 -pix_fmt yuv420p10le \
          -preset ${{ github.event.inputs.preset }} \
          -crf ${{ github.event.inputs.crf }} \
          $RATE_ARGS -svtav1-params "$SVT_PARAMS" \
          -c:a libopus -b:a ${{ github.event.inputs.audio_bitrate }} -ac 2 \
          -c:s copy \
          "$OUT_NAME"

    - name: Show Results
      run: |
        echo "=== MediaInfo ==="
        mediainfo "$OUT_NAME" | head -n 20
        echo "Filesize:"
        du -sh "$OUT_NAME"

    - name: Generate Comparison
      run: |
        mkdir -p screenshots
        DUR_MS=$(ffprobe -v quiet -show_entries format=duration -of csv=p=0 "$OUT_NAME" | python3 -c "import sys; print(int(float(sys.stdin.read().strip())*1000))")
        python3 -c "
        import random
        d = $DUR_MS
        ts = sorted(random.sample(range(2000, d - 2000), min(5, (d-4000)//2000))) if d > 5000 else [d//2]
        for t in ts: print(t/1000.0)
        " > timestamps.txt
        
        i=1
        while read -r T; do
          ffmpeg -nostdin -ss "$T" -i reference.mkv -frames:v 1 -vf "scale=960:-1" -q:v 2 "screenshots/src_$i.png" -y 2>/dev/null
          ffmpeg -nostdin -ss "$T" -i "$OUT_NAME" -frames:v 1 -vf "scale=960:-1" -q:v 2 "screenshots/enc_$i.png" -y 2>/dev/null
          convert \
            \( "screenshots/src_$i.png" -gravity North -background '#00000099' -splice 0x30 -fill white -font DejaVu-Sans -pointsize 20 -annotate +0+6 "SOURCE | $T" \) \
            \( "screenshots/enc_$i.png" -gravity North -background '#00000099' -splice 0x30 -fill white -font DejaVu-Sans -pointsize 20 -annotate +0+6 "AV1 | CRF ${{ github.event.inputs.crf }}" \) \
            +append "screenshots/compare_$i.jpg"
          i=$((i + 1))
        done < timestamps.txt

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: "AV1-Encoded-Video"
        path: |
          ${{ env.OUT_NAME }}
          screenshots/*.jpg