name: Encode and Send

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Index Link'
        required: true
      custom_name:
        description: 'Formatted Name from HF Bot'
        required: true

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg python3-pip
          pip install pyrogram tgcrypto

      # ----------------------------
      # SAFE URL DOWNLOAD (Production Grade)
      # ----------------------------
      - name: ğŸ“¥ Download Source (Safe URL Encode)
        run: |
          python3 - <<EOF
import urllib.parse
import subprocess

url = "${{ github.event.inputs.video_url }}"

parsed = urllib.parse.urlsplit(url)

encoded_path = urllib.parse.quote(parsed.path)
encoded_query = urllib.parse.quote_plus(parsed.query, safe="=&")

safe_url = urllib.parse.urlunsplit((
    parsed.scheme,
    parsed.netloc,
    encoded_path,
    encoded_query,
    parsed.fragment
))

print("Final Encoded URL:", safe_url)

subprocess.run(
    ["curl", "-L", "--fail", "--retry", "3", "-o", "source.mkv", safe_url],
    check=True
)
EOF

      - name: ğŸ“Š Show Source File Info
        run: |
          ls -lh source.mkv
          ffprobe -hide_banner source.mkv

      # ----------------------------
      # AV1 ENCODE (Balanced Quality/Size)
      # ----------------------------
      - name: âš™ï¸ SVT-AV1 Encode
        run: |
          ffmpeg -i source.mkv \
          -map 0:v -map 0:a? \
          -c:v libsvtav1 \
          -preset 8 \
          -crf 40 \
          -pix_fmt yuv420p10le \
          -svtav1-params tune=0:film-grain=0:keyint=480 \
          -vf "scale=1920:1080:flags=lanczos" \
          -c:a libopus -b:a 48k \
          -movflags +faststart \
          "${{ github.event.inputs.custom_name }}.mkv"

      - name: ğŸ“Š Show Encoded File Info
        run: |
          ls -lh "${{ github.event.inputs.custom_name }}.mkv"

      # ----------------------------
      # TELEGRAM UPLOAD
      # ----------------------------
      - name: ğŸ“¤ Upload via UserBot
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          FILE_NAME: "${{ github.event.inputs.custom_name }}.mkv"
        run: python uploader.py
