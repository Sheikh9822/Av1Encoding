name: Ultra Compress Encode & Send

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Index Link'
        required: true
      custom_name:
        description: 'Formatted Name for Output'
        required: true

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # Max ~8 hours for ultra slow preset

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ›  Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl python3-pip
          pip install pyrogram tgcrypto psutil

      - name: ðŸ“¥ Download Source
        run: |
          URL="${{ github.event.inputs.video_url }}"
          echo "Downloading source from: $URL"
          curl --globoff -L \
               --retry 5 \
               --retry-delay 5 \
               --fail \
               --connect-timeout 30 \
               -o "source.mkv" \
               "$URL"
          echo "âœ… Download completed."
          ls -lh source.mkv

      - name: ðŸš€ Encode + Upload to Telegram
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          FILE_NAME: "${{ github.event.inputs.custom_name }}.mkv"
        run: python uploader.py
