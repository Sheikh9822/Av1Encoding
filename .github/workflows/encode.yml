name: AV1 Universal Pipeline
run-name: "ðŸš€ [MISSION]: ${{ inputs.ui_title || inputs.custom_name || 'Target' }}"

on:
  workflow_dispatch:
    inputs:
      ui_title:
        description: 'Dashboard Title'
      video_url:
        description: 'Link (TG, M3U8, or Direct CDN)'
        required: true
      custom_name:
        description: 'Output Filename'
      res_choice:
        description: 'Resolution'
      custom_crf:
        description: 'CRF'
        default: '42'
      custom_preset:
        description: 'Preset'
        default: '6'
      film_grain:
        description: 'Grain'
        default: '0'
      audio_mode:
        description: 'Audio Mode'
        default: 'opus'
      audio_bitrate:
        description: 'Audio Bitrate'
        default: '128k'
      run_vmaf:
        description: 'Run VMAF?'
        default: 'true'

jobs:
  # PHASE 1: SMART DOWNLOADER
  download_phase:
    runs-on: ubuntu-latest
    concurrency:
      group: >-
        ${{ 
          (!contains(inputs.video_url, 't.me') && !contains(inputs.video_url, 'tg_file:')) && github.run_id || 
          (
            (endsWith(github.run_number, '0') || endsWith(github.run_number, '3') || endsWith(github.run_number, '6') || endsWith(github.run_number, '9')) && 'tg-lane-A' ||
            (endsWith(github.run_number, '1') || endsWith(github.run_number, '4') || endsWith(github.run_number, '7')) && 'tg-lane-B' || 
            'tg-lane-C'
          )
        }}
      cancel-in-progress: false
    outputs:
      final_name: ${{ steps.get_name.outputs.NAME }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ðŸ›  Install Tools
        run: |
          sudo apt-get update && sudo apt-get install -y aria2
          pip install pyrogram tgcrypto yt-dlp

      - name: ðŸ“ Setup Session
        run: mkdir -p tg_session_dir

      - name: ðŸ’¾ Restore Session Cache
        uses: actions/cache@v4
        with:
          path: tg_session_dir
          key: tg-session-master

      - name: ðŸ“¥ Universal Download
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          VIDEO_URL: ${{ github.event.inputs.video_url }}
          CUSTOM: ${{ github.event.inputs.custom_name }}
        run: |
          URL="$VIDEO_URL"
          
          # Telegram Logic
          if [[ "$URL" == tg_file:* ]] || [[ "$URL" == https://t.me/* ]]; then
            python3 tg_handler.py
          # Magnet Safety
          elif [[ "$URL" == magnet:* ]]; then
            echo "âŒ ERROR: Magnet links are disabled." && exit 1
          # Direct/CDN Logic
          else
            if [ -z "$CUSTOM" ]; then
                # Handle cases like kwik where filename is in query param ?file=...
                if [[ "$URL" == *"file="* ]]; then
                    CLEAN_NAME=$(echo "$URL" | sed -n 's/.*file=\([^&]*\).*/\1/p' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
                else
                    CLEAN_NAME=$(basename "$URL" | sed 's/\?.*//' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
                fi
                
                # Validation
                if [[ "$CLEAN_NAME" != *.mkv ]] && [[ "$CLEAN_NAME" != *.mp4 ]] && [[ "$CLEAN_NAME" != *.webm ]]; then
                    FN="video.mkv"
                else
                    FN="$CLEAN_NAME"
                fi
            else
                FN="${CUSTOM}.mkv"
            fi
            
            echo "ðŸ“¥ Downloading via yt-dlp (Smart Mode): $URL"
            
            # Using yt-dlp handles headers/cookies like a browser.
            # We hook aria2c into it for multi-connection speed.
            yt-dlp --no-check-certificate \
              --user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36" \
              --downloader aria2c \
              --downloader-args "aria2c:-x 16 -s 16 -k 1M" \
              -o "source.mkv" \
              "$URL"
            
            echo "$FN" > tg_fname.txt
          fi

      - name: ðŸ· Extract Filename
        id: get_name
        run: echo "NAME=$(cat tg_fname.txt)" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: payload-${{ github.run_id }}
          path: |
            source.mkv
            tg_fname.txt
          retention-days: 1
          compression-level: 0

  # PHASE 2: PARALLEL ENCODER
  encode_phase:
    needs: download_phase
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ðŸ›  Install Encoding Tools
        run: |
          sudo apt-get update && sudo apt-get install -y mkvtoolnix curl
          pip install -r requirements.txt
          wget -q https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar -xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo cp ffmpeg-master-latest-linux64-gpl/bin/ff* /usr/local/bin/

      - name: ðŸ“¥ Fetch Payload
        uses: actions/download-artifact@v4
        with:
          name: payload-${{ github.run_id }}

      - name: ðŸ’¾ Restore Session Cache
        uses: actions/cache@v4
        with:
          path: tg_session_dir
          key: tg-session-master

      - name: ðŸ”‘ Authorize Bot Session
        run: |
          if [ -f "tg_session_dir/tg_dl_session.session" ]; then
            cp tg_session_dir/tg_dl_session.session ./enc_session.session
            echo "âœ… Session copied successfully."
          fi

      - name: ðŸš€ Start Parallel Encoder
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          SESSION_NAME: "enc_session"
          USER_RES: ${{ github.event.inputs.res_choice }}
          USER_CRF: ${{ github.event.inputs.custom_crf }}
          USER_PRESET: ${{ github.event.inputs.custom_preset }}
          USER_GRAIN: ${{ github.event.inputs.film_grain }}
          AUDIO_MODE: ${{ github.event.inputs.audio_mode }}
          AUDIO_BITRATE: ${{ github.event.inputs.audio_bitrate }}
          RUN_VMAF: ${{ github.event.inputs.run_vmaf }}
          FILE_NAME: ${{ needs.download_phase.outputs.final_name }}
        run: python3 main.py