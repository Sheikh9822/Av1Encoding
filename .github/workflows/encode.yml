name: AV1 Encode & Send
run-name: "Encoding: ${{ inputs.ui_title || inputs.custom_name || 'Auto-Detected' }}"

on:
  workflow_dispatch:
    inputs:
      ui_title:
        description: 'Dashboard Display Title'
      video_url:
        description: 'Magnet, YouTube, or Telegram Link'
        required: true
      custom_name:
        description: 'Output Filename (Optional)'
      res_choice:
        description: 'Resolution (e.g. 1080, 720)'
      custom_crf:
        description: 'CRF (Default 42)'
        default: '42'
      custom_preset:
        description: 'Preset (Default 6)'
        default: '6'
      film_grain:
        description: 'Grain (0-50)'
        default: '0'
      audio_mode:
        description: 'Audio: opus or copy'
        default: 'opus'
      audio_bitrate:
        description: 'Audio Bitrate (e.g. 128k)'
        default: '128k'
      run_vmaf:
        description: 'Run VMAF Analysis? (true/false)'
        default: 'true'

jobs:
  encode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ðŸ›  Install FFmpeg & Tools
        run: |
          sudo apt-get update && sudo apt-get install -y aria2 mkvtoolnix
          pip install -r requirements.txt
          wget -q https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar -xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo cp ffmpeg-master-latest-linux64-gpl/bin/ff* /usr/local/bin/

      - name: ðŸ“ Setup Session Directory & Cache
        run: mkdir -p tg_session_dir

      - name: ðŸ’¾ Cache Telegram Session
        uses: actions/cache@v4
        with:
          path: tg_session_dir
          key: tg-session-v2

      - name: ðŸ“¥ Download Video
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          VIDEO_URL: ${{ github.event.inputs.video_url }}
        run: |
          URL="${{ github.event.inputs.video_url }}"
          CUSTOM="${{ github.event.inputs.custom_name }}"
          
          if [[ "$URL" == magnet:* ]]; then
            mkdir -p dl_temp
            aria2c --seed-time=0 --max-connection-per-server=16 --dir=./dl_temp "$URL"
            DL_FILE=$(find ./dl_temp -type f -size +50M | head -n 1)
            [ -z "$CUSTOM" ] && FINAL_NAME="$(basename "$DL_FILE")" || FINAL_NAME="${CUSTOM}.mkv"
            mv "$DL_FILE" ./source.mkv
            
          elif [[ "$URL" == tg_file:* ]] || [[ "$URL" == https://t.me/* ]]; then
            python3 tg_handler.py
            if [ -z "$CUSTOM" ]; then
              [ -f "tg_fname.txt" ] && FINAL_NAME="$(cat tg_fname.txt)" || FINAL_NAME="Telegram_Video.mkv"
            else
              FINAL_NAME="${CUSTOM}.mkv"
            fi
            
          else
            [ -z "$CUSTOM" ] && FINAL_NAME="$(yt-dlp --get-title "$URL").mkv" || FINAL_NAME="${CUSTOM}.mkv"
            yt-dlp --downloader aria2c --merge-output-format mkv -o "source.mkv" "$URL"
          fi
          
          FINAL_NAME="${FINAL_NAME%.*}.mkv"
          echo "FILE_NAME=$FINAL_NAME" >> $GITHUB_ENV

      - name: ðŸš€ Execute Encoder
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          USER_RES: ${{ github.event.inputs.res_choice }}
          USER_CRF: ${{ github.event.inputs.custom_crf }}
          USER_PRESET: ${{ github.event.inputs.custom_preset }}
          USER_GRAIN: ${{ github.event.inputs.film_grain }}
          AUDIO_MODE: ${{ github.event.inputs.audio_mode }}
          AUDIO_BITRATE: ${{ github.event.inputs.audio_bitrate }}
          RUN_VMAF: ${{ github.event.inputs.run_vmaf }}
        run: python3 main.py