name: AV1 Dual-Lane Pipeline
run-name: "üöÄ [STAGE-1]: ${{ inputs.ui_title || inputs.custom_name || 'Targeting Mission' }}"

on:
  workflow_dispatch:
    inputs:
      ui_title:
        description: 'Dashboard Title'
        required: false
      video_url:
        description: 'Telegram Post Link'
        required: true
      custom_name:
        description: 'Output Filename (Optional)'
        required: false
      res_choice:
        description: 'Resolution (e.g. 1080, 720)'
        required: false
      custom_crf:
        description: 'CRF (Default 42)'
        default: '42'
      custom_preset:
        description: 'Preset (Default 6)'
        default: '6'
      film_grain:
        description: 'Grain (0-50)'
        default: '0'
      audio_mode:
        description: 'Audio: opus or copy'
        default: 'opus'
      audio_bitrate:
        description: 'Audio Bitrate (e.g. 128k)'
        default: '128k'
      run_vmaf:
        description: 'Run VMAF Quality Check? (true/false)'
        default: 'true'

jobs:
  # -------------------------------------------------------------------------
  # STAGE 1: THE DOWNLOADER (Restricted to 2 global lanes)
  # -------------------------------------------------------------------------
  download_phase:
    runs-on: ubuntu-latest
    concurrency:
      # Modulo logic ensures exactly 2 downloads can run at once
      group: telegram-lane-${{ github.run_number % 2 }}
      cancel-in-progress: false
    outputs:
      final_name: ${{ steps.get_name.outputs.NAME }}
    steps:
      - name: üõ∞Ô∏è Checkout Code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üõ† Install Download Tools
        run: pip install pyrogram tgcrypto

      - name: üìÅ Setup Session Directory
        run: mkdir -p tg_session_dir

      - name: üíæ Restore Session Cache
        uses: actions/cache@v4
        with:
          path: tg_session_dir
          key: tg-session-master

      - name: üì• Download from Telegram
        env:
          TG_API_ID: ${{ secrets.TG_API_ID }}
          TG_API_HASH: ${{ secrets.TG_API_HASH }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          VIDEO_URL: ${{ github.event.inputs.video_url }}
        run: python3 tg_handler.py

      - name: üè∑ Extract Filename
        id: get_name
        run: |
          FN=$(cat tg_fname.txt)
          echo "NAME=$FN" >> $GITHUB_OUTPUT

      - name: üì¶ Upload Payload to Internal Storage
        uses: actions/upload-artifact@v4
        with:
          # Unique identifier for this specific mission
          name: payload-${{ github.run_id }}
          path: |
            source.mkv
            tg_fname.txt
          retention-days: 1
          # Disable compression for speed (video is already compressed)
          compression-level: 0

  # -------------------------------------------------------------------------
  # STAGE 2: THE ENCODER (Parallelized - No limits)
  # -------------------------------------------------------------------------
  encode_phase:
    needs: download_phase
    runs-on: ubuntu-latest
    timeout-minutes: 480
    steps:
      - name: üõ∞Ô∏è Checkout Code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: üõ† Install Encoding Tools & FFmpeg
        run: |
          sudo apt-get update && sudo apt-get install -y mkvtoolnix curl
          pip install -r requirements.txt
          # Download specialized FFmpeg for VMAF
          wget -q https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar -xf ffmpeg-master-latest-linux64-gpl.tar.xz
          sudo cp ffmpeg-master-latest-linux64-gpl/bin/ff* /usr/local/bin/

      - name: üì• Fetch Payload from Storage
        uses: actions/download-artifact@v4
        with:
          name: payload-${{ github.run_id }}

      - name: üöÄ Execute Sci-Fi Encoder
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          USER_RES: ${{ github.event.inputs.res_choice }}
          USER_CRF: ${{ github.event.inputs.custom_crf }}
          USER_PRESET: ${{ github.event.inputs.custom_preset }}
          USER_GRAIN: ${{ github.event.inputs.film_grain }}
          AUDIO_MODE: ${{ github.event.inputs.audio_mode }}
          AUDIO_BITRATE: ${{ github.event.inputs.audio_bitrate }}
          RUN_VMAF: ${{ github.event.inputs.run_vmaf }}
          # Pass the detected name to the script
          FILE_NAME: ${{ needs.download_phase.outputs.final_name }}
        run: python3 main.py