name: Encode and Send
run-name: "Encoding: ${{ github.event.inputs.custom_name || 'Auto-Extracted File' }}"

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Link, YouTube URL, or Magnet Link'
        required: true
      custom_name:
        description: 'Output Filename (Optional - Leave blank to auto-detect)'
        required: false
      res_choice:
        description: 'Resolution (e.g., 1080, 720) - Leave empty for Original'
        required: false
      custom_crf:
        description: 'CRF (Default: 42)'
        default: '42'
        required: false
      custom_preset:
        description: 'SVT-AV1 Preset (Default: 6)'
        default: '6'
        required: false
      audio_mode:
        description: 'Audio: opus or copy'
        default: 'opus'
        required: false
      audio_bitrate:
        description: 'Opus Bitrate (128k, 160k, 192k)'
        default: '128k'
        required: false
      run_ssim:
        description: 'Calculate SSIM Quality Score? (true/false)'
        default: 'true'
        required: false

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ðŸ›  Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl mkvtoolnix aria2
          pip install -r requirements.txt yt-dlp

      - name: ðŸ’¾ Restore Telegram Session
        uses: actions/cache@v4
        with:
          path: uploader.session
          key: tg-session-v1
          restore-keys: |
            tg-session-

      - name: ðŸ“¥ Universal Download & Auto-Naming
        id: downloader
        run: |
          URL="${{ github.event.inputs.video_url }}"
          CUSTOM="${{ github.event.inputs.custom_name }}"
          
          if [[ "$URL" == magnet:* ]]; then
            echo "ðŸ§² Magnet link detected..."
            mkdir -p dl_temp
            aria2c --seed-time=0 --max-connection-per-server=16 --split=16 --dir=./dl_temp "$URL"
            # Find the largest file (the actual video)
            ORIG_FILE=$(find ./dl_temp -type f -size +50M | head -n 1)
            EXTRACTED=$(basename "$ORIG_FILE")
            EXTRACTED="${EXTRACTED%.*}" # Strip extension
            mv "$ORIG_FILE" ./source.mkv
          else
            echo "ðŸŒ Video URL detected..."
            # Extract title using yt-dlp without downloading yet
            EXTRACTED=$(yt-dlp --no-playlist --print filename -o "%(title)s" "$URL" | head -n 1)
            # Actually download the file
            yt-dlp --no-playlist --merge-output-format mkv -o "source.mkv" "$URL"
          fi

          # Fallback logic: Use Custom if provided, else Extracted, else default
          FINAL_NAME="${CUSTOM:-$EXTRACTED}"
          FINAL_NAME="${FINAL_NAME:-Unknown_Video}"
          
          # Clean filename to prevent Linux/Telegram errors (keeps alphanumeric, dots, dashes, underscores)
          FINAL_NAME=$(echo "$FINAL_NAME" | sed 's/[^a-zA-Z0-9_.-]/_/g')
          
          echo "Title locked in as: $FINAL_NAME"
          # Export to environment for the next step
          echo "FILE_TITLE=$FINAL_NAME" >> $GITHUB_ENV

      - name: ðŸš€ Execute Sci-Fi Encoder
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          # Use the newly extracted variable here:
          FILE_NAME: "${{ env.FILE_TITLE }}.mkv"
          USER_RES: ${{ github.event.inputs.res_choice }}
          USER_CRF: ${{ github.event.inputs.custom_crf }}
          USER_PRESET: ${{ github.event.inputs.custom_preset }}
          AUDIO_MODE: ${{ github.event.inputs.audio_mode }}
          AUDIO_BITRATE: ${{ github.event.inputs.audio_bitrate }}
          RUN_SSIM: ${{ github.event.inputs.run_ssim }}
        run: python uploader.py
