name: Encode and Send

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Index Link'
        required: true
      custom_name:
        description: 'Formatted Name from HF Bot'
        required: true

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # Automatically caches pip dependencies

      - name: üõ† Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg curl
          pip install pyrogram tgcrypto

      - name: üì• Download Source (Glob Disabled)
        run: |
          URL="${{ github.event.inputs.video_url }}"
          echo "Downloading: $URL"

          curl --globoff -L \
               --retry 5 \
               --retry-delay 5 \
               --fail \
               --connect-timeout 30 \
               -o "source.mkv" \
               "$URL"

          echo "Download completed."
          ls -lh source.mkv

      - name: üöÄ Encode + Upload
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          FILE_NAME: "${{ github.event.inputs.custom_name }}.mkv"
        run: python uploader.py
        
