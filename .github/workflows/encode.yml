name: Encode and Send
run-name: "Encoding: ${{ github.event.inputs.custom_name }}"

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct Link to Video'
        required: true
      custom_name:
        description: 'Output Filename (no ext)'
        required: true
      res_choice:
        description: 'Resolution (e.g., 1080)'
        required: false
      custom_crf:
        description: 'CRF (Default: 42)'
        default: '42'
        required: false
      custom_preset:
        description: 'Preset (Default: 6)'
        default: '6'
        required: false
      audio_mode:
        description: 'opus or copy'
        default: 'opus'
        required: false
      audio_bitrate:
        description: 'Opus Bitrate'
        default: '128k'
        required: false
      run_vmaf:
        description: 'Calculate Quality Score? (true/false)'
        default: 'true'
        required: false

jobs:
  encode:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ðŸ›  Install SVT-AV1 + VMAF Static FFmpeg
        run: |
          sudo apt-get update && sudo apt-get install -y curl tar wget
          # Using a build that explicitly includes SVT-AV1 and VMAF
          wget https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar xvf ffmpeg-master-latest-linux64-gpl.tar.xz
          # Move binaries to path
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffmpeg /usr/local/bin/
          sudo mv ffmpeg-master-latest-linux64-gpl/bin/ffprobe /usr/local/bin/
          # Clean up
          rm -rf ffmpeg-master-latest-linux64-gpl*
          pip install -r requirements.txt

      - name: ðŸ“¥ Download Source
        run: curl --globoff -L -o "source.mkv" "${{ github.event.inputs.video_url }}"

      - name: ðŸš€ Execute Sci-Fi Encoder
        env:
          API_ID: ${{ secrets.TG_API_ID }}
          API_HASH: ${{ secrets.TG_API_HASH }}
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          FILE_NAME: "${{ github.event.inputs.custom_name }}.mkv"
          USER_RES: ${{ github.event.inputs.res_choice }}
          USER_CRF: ${{ github.event.inputs.custom_crf }}
          USER_PRESET: ${{ github.event.inputs.custom_preset }}
          AUDIO_MODE: ${{ github.event.inputs.audio_mode }}
          AUDIO_BITRATE: ${{ github.event.inputs.audio_bitrate }}
          RUN_VMAF: ${{ github.event.inputs.run_vmaf }}
        run: python uploader.py
